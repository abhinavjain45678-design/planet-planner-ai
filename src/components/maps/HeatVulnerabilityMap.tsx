import { useEffect, useRef } from "react";
import L from "leaflet";
import "leaflet/dist/leaflet.css";

const HeatVulnerabilityMap = () => {
  const mapRef = useRef<HTMLDivElement>(null);
  const mapInstanceRef = useRef<L.Map | null>(null);

  useEffect(() => {
    if (!mapRef.current || mapInstanceRef.current) return;

    const map = L.map(mapRef.current).setView([34.0522, -118.2437], 11);
    mapInstanceRef.current = map;

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Simulated heat vulnerability zones
    const heatZones = [
      { center: [34.0522, -118.2437], radius: 2000, intensity: "critical", temp: "42°C" },
      { center: [34.0722, -118.2637], radius: 1500, intensity: "high", temp: "38°C" },
      { center: [34.0422, -118.2237], radius: 1800, intensity: "medium", temp: "35°C" },
    ];

    heatZones.forEach(zone => {
      const color = zone.intensity === "critical" ? "#FF4444" : 
                    zone.intensity === "high" ? "#FF8800" : "#FFAA00";
      
      L.circle([zone.center[0], zone.center[1]], {
        color: color,
        fillColor: color,
        fillOpacity: 0.3,
        radius: zone.radius,
      }).addTo(map).bindPopup(`
        <strong>Heat Zone: ${zone.intensity.toUpperCase()}</strong><br>
        Surface Temperature: ${zone.temp}<br>
        Vulnerability Index: ${zone.intensity === "critical" ? "9/10" : zone.intensity === "high" ? "7/10" : "5/10"}
      `);
    });

    // Add legend
    const legend = new L.Control({ position: 'bottomright' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'info legend');
      div.style.background = 'white';
      div.style.padding = '10px';
      div.style.borderRadius = '5px';
      div.innerHTML = `
        <strong>Heat Vulnerability</strong><br>
        <span style="color: #FF4444;">●</span> Critical (>40°C)<br>
        <span style="color: #FF8800;">●</span> High (35-40°C)<br>
        <span style="color: #FFAA00;">●</span> Medium (30-35°C)
      `;
      return div;
    };
    legend.addTo(map);

    return () => {
      if (mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
      }
    };
  }, []);

  return <div ref={mapRef} className="w-full h-[500px] rounded-lg" />;
};

export default HeatVulnerabilityMap;
